# Spec file for Open vSwitch.

# Copyright (C) 2009, 2010 Nicira Networks, Inc.
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.  This file is offered as-is,
# without warranty of any kind.

%{!?kversion:%define kversion %(/bin/ls -tr /usr/src/kernels | tail -1)}
%{!?buildversion:%define buildversion 1}

%define _unpackaged_files_terminate_build 0 

Name: openvswitch-gbp-kmod
Summary: Open vSwitch Kernel Modules
Group: System/Kernel
URL: http://www.openvswitch.org/
Vendor: OpenSource Security Ralf Spenneberg <ralf@os-s.net>
Version: @VERSION@

# The entire source code is ASL 2.0 except datapath/ which is GPLv2
License: GPLv2
Release: %{buildversion}%{?dist}
Source: openvswitch-%{version}.tar.gz
BuildRequires: %kernel_module_package_buildreqs
BuildRequires: openssl-devel
BuildRequires: kernel-devel = 3.10.0-229.14.1.el7
Requires: kernel >= 3.10.0-229.14.1.el7
Provides: openvswitch-gbp-kmod
Obsoletes: openvswitch-kmod

%description
Open vSwitch provides standard network bridging functions augmented with
support for the OpenFlow protocol for remote per-flow control of
traffic. This package contains the kernel modules.

%prep
%setup -q -n openvswitch-%{version}
cat > openvswitch.conf <<EOF
override openvswitch * extra/openvswitch
override openvswitch * weak-updates/openvswitch
override openvswitch * weak-updates
EOF

%build
./configure --prefix=/usr --sysconfdir=/etc --localstatedir=%{_localstatedir} --with-linux=/usr/src/kernels/%{kversion} --enable-ssl
make %{_smp_mflags} -C datapath/linux

%install
export INSTALL_MOD_PATH=$RPM_BUILD_ROOT
export INSTALL_MOD_DIR=extra/openvswitch
make -C /usr/src/kernels/%{kversion} modules_install M="`pwd`"/datapath/linux

install -d %{buildroot}%{_sysconfdir}/depmod.d/
install -m 644 openvswitch.conf %{buildroot}%{_sysconfdir}/depmod.d/

%clean
rm -rf $RPM_BUILD_ROOT

%post
if [ -e "/boot/System.map-%{kversion}" ]; then
    /sbin/depmod -aeF /boot/System.map-%{kversion} %{kversion} > /dev/null || :
fi

modules=( $(find /lib/modules/%{kversion}/extra/openvswitch/ -name '*.ko') )
if [ -x "/sbin/weak-modules" ]; then
    printf '%s\n' "${modules[@]}"     | /sbin/weak-modules --add-modules
fi


%preun
find /lib/modules/%{kversion}/extra/openvswitch/ -name '*.ko' > /var/run/rpm-kmod-%{name}-modules

%postun
if [ -e "/boot/System.map-%{kversion}" ]; then
    /sbin/depmod -aF /boot/System.map-%{kversion} %{kversion} > /dev/null || :
fi
if [ "$1" = 0 ];then
    modules=( $(cat /var/run/rpm-kmod-%{name}-modules) )
    if [ -x "/sbin/weak-modules" ]; then
        printf '%s\n' "${modules[@]}"         | /sbin/weak-modules --remove-modules
    fi
fi

%files
%defattr(-,root,root)
/lib/modules/%{kversion}/extra/openvswitch/openvswitch.ko
/lib/modules/%{kversion}/extra/openvswitch/vport-geneve.ko
/lib/modules/%{kversion}/extra/openvswitch/vport-gre.ko
/lib/modules/%{kversion}/extra/openvswitch/vport-lisp.ko
/lib/modules/%{kversion}/extra/openvswitch/vport-stt.ko
%config %{_sysconfdir}/depmod.d/openvswitch.conf

%changelog
* Thu Dec 11 2014 Rob Adams <readams@readams.net>
- Allow building for any kernel version and add depmod conf file
- Use weak-modules to allow installing to any RHEL7 system
* Wed Sep 21 2011 Kyle Mestery <kmestery@cisco.com>
- Updated for F15
* Wed Jan 12 2011 Ralf Spenneberg <ralf@os-s.net>
- First build on F14
